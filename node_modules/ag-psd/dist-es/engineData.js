export function parseEngineData(data) {
    var openBracket = '('.charCodeAt(0);
    var closeBracket = ')'.charCodeAt(0);
    var text = '';
    for (var i = 0; i < data.length; i++) {
        if (i < data.length - 3 && data[i] === openBracket && data[i + 1] === 0xfe && data[i + 2] === 0xff) {
            text += String.fromCharCode(data[i]);
            for (i += 3; i < (data.length - 1) && data[i] !== closeBracket; i += 2) {
                text += String.fromCharCode((data[i] << 8) | data[i + 1]);
            }
            i--;
        }
        else {
            text += String.fromCharCode(data[i]);
        }
    }
    var lines = text.split(/\n/g);
    var nodeStack = [];
    var propertyStack = [];
    var node = undefined;
    var property;
    function updateNode(propertyValue, nodeValue) {
        if (Array.isArray(nodeValue)) {
            nodeValue.push(node);
        }
        else if (nodeValue) {
            nodeValue[propertyValue] = node;
        }
    }
    var instructions = [
        {
            regex: /^<<$/,
            parse: function () {
                nodeStack.push(node);
                propertyStack.push(property);
                node = {};
                property = undefined;
            }
        },
        {
            regex: /^>>$/,
            parse: function () {
                var nodeValue = nodeStack.pop();
                var propertyValue = propertyStack.pop();
                if (nodeValue) {
                    updateNode(propertyValue, nodeValue);
                    node = nodeValue;
                }
            },
        },
        {
            regex: /^\[(.*)\]$/,
            parse: function (match) {
                var trimmed = match[1].trim();
                return trimmed ? trimmed.split(/ /g).map(parseTokens) : [];
            }
        },
        {
            regex: /^\/(\w+) \[$/,
            parse: function (match) {
                nodeStack.push(node);
                propertyStack.push(match[1]);
                node = [];
                property = undefined;
            }
        },
        {
            regex: /^\]$/,
            parse: function () {
                var nodeValue = nodeStack.pop();
                var propertyValue = propertyStack.pop();
                updateNode(propertyValue, nodeValue);
                node = nodeValue;
            }
        },
        {
            regex: /^\/([A-Z0-9]+)$/i,
            parse: function (match) {
                property = match[1];
            }
        },
        {
            regex: /^\/([A-Z0-9]+) ([^]*)$/i,
            parse: function (match) {
                property = match[1];
                var data = parseTokens(match[2]);
                if (Array.isArray(node)) {
                    node.push(data);
                }
                else if (node) {
                    node[property] = data;
                }
                return data;
            }
        },
        {
            regex: /^\(([^]*)\)$/m,
            parse: function (match) {
                return match[1]; // .trim();
            }
        },
        {
            regex: /^(-?\d*\.\d+)$/,
            parse: function (match) {
                return parseFloat(match[1]);
            }
        },
        {
            regex: /^(-?\d+)$/,
            parse: function (match) {
                return parseInt(match[1], 10);
            }
        },
        {
            regex: /^(true|false)$/,
            parse: function (match) {
                return match[1] === 'true';
            }
        },
        {
            regex: /^$/,
            parse: function () {
            }
        },
    ];
    for (var _i = 0, lines_1 = lines; _i < lines_1.length; _i++) {
        var line = lines_1[_i];
        var cleaned = line.replace(/\t/g, '').trim();
        parseTokens(cleaned);
    }
    function parseTokens(line) {
        for (var _i = 0, instructions_1 = instructions; _i < instructions_1.length; _i++) {
            var _a = instructions_1[_i], regex = _a.regex, parse = _a.parse;
            var match = regex.exec(line);
            if (match) {
                return parse(match);
            }
        }
        throw new Error("Unparsed engine data line: " + line);
    }
    // console.log(JSON.stringify(node, null, 2)); // .substr(0, 1000));
    // require('fs').writeFileSync('engineData.json', JSON.stringify(node, null, 2), 'utf8');
    return node;
}
export function serializeEngineData(data) {
    var indent = '';
    var lines = ['', ''];
    function serializeProperty(key, value) {
        var index = lines.length;
        lines.push(indent + "/" + key);
        var serialized = serializeValue(value);
        if (serialized) {
            lines[index] += ' ' + serialized;
        }
    }
    function serializeNumber(value) {
        if ((value | 0) === value) {
            return value.toString();
        }
        else {
            return value.toFixed(3).replace(/(\d)0+$/g, '$1');
        }
    }
    function serializeValue(value) {
        if (typeof value === 'number') {
            return serializeNumber(value);
        }
        else if (typeof value === 'boolean') {
            return value ? 'true' : 'false';
        }
        else if (typeof value === 'string') {
            var encoded = '\u00fe\u00ff';
            for (var i = 0; i < value.length; i++) {
                var charCode = value.charCodeAt(i);
                encoded += "" + String.fromCharCode(charCode >> 8) + String.fromCharCode(charCode & 0xff);
            }
            return "(" + encoded + ")";
        }
        else if (Array.isArray(value)) {
            if (value.every(function (x) { return typeof x === 'number'; })) {
                return "[ " + value.map(serializeNumber).join(' ') + " ]";
            }
            else {
                var temp = indent;
                indent = indent + '\t';
                for (var i = 0; i < value.length; i++) {
                    var serialized = serializeValue(value[i]);
                    if (serialized) {
                        lines.push("" + indent + serialized);
                    }
                }
                indent = temp;
                lines.push(indent + "]");
                return '[';
            }
        }
        else if (typeof value === 'object') {
            lines.push(indent + "<<");
            var temp = indent;
            indent = indent + '\t';
            for (var _i = 0, _a = Object.keys(value); _i < _a.length; _i++) {
                var key = _a[_i];
                serializeProperty(key, value[key]);
            }
            indent = temp;
            lines.push(indent + ">>");
        }
        return undefined;
    }
    serializeValue(data);
    var buffer = new Uint8Array(lines.reduce(function (sum, line) { return sum + line.length + 1; }, 0) - 1);
    var offset = 0;
    for (var _i = 0, lines_2 = lines; _i < lines_2.length; _i++) {
        var line = lines_2[_i];
        for (var i = 0; i < line.length; i++, offset++) {
            buffer[offset] = line.charCodeAt(i);
        }
        buffer[offset] = '\n'.charCodeAt(0);
        offset++;
    }
    // console.log('serialized:\n', lines.join('\n'));
    return buffer;
}

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImVuZ2luZURhdGEudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsTUFBTSxVQUFVLGVBQWUsQ0FBQyxJQUFjO0lBQzdDLElBQU0sV0FBVyxHQUFHLEdBQUcsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDdEMsSUFBTSxZQUFZLEdBQUcsR0FBRyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUN2QyxJQUFJLElBQUksR0FBRyxFQUFFLENBQUM7SUFFZCxLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRTtRQUNyQyxJQUFJLENBQUMsR0FBRyxJQUFJLENBQUMsTUFBTSxHQUFHLENBQUMsSUFBSSxJQUFJLENBQUMsQ0FBQyxDQUFDLEtBQUssV0FBVyxJQUFJLElBQUksQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEtBQUssSUFBSSxJQUFJLElBQUksQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEtBQUssSUFBSSxFQUFFO1lBQ25HLElBQUksSUFBSSxNQUFNLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBRXJDLEtBQUssQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxJQUFJLElBQUksQ0FBQyxDQUFDLENBQUMsS0FBSyxZQUFZLEVBQUUsQ0FBQyxJQUFJLENBQUMsRUFBRTtnQkFDdkUsSUFBSSxJQUFJLE1BQU0sQ0FBQyxZQUFZLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO2FBQzFEO1lBRUQsQ0FBQyxFQUFFLENBQUM7U0FDSjthQUFNO1lBQ04sSUFBSSxJQUFJLE1BQU0sQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7U0FDckM7S0FDRDtJQUVELElBQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDaEMsSUFBTSxTQUFTLEdBQVUsRUFBRSxDQUFDO0lBQzVCLElBQU0sYUFBYSxHQUEyQixFQUFFLENBQUM7SUFFakQsSUFBSSxJQUFJLEdBQVEsU0FBUyxDQUFDO0lBQzFCLElBQUksUUFBNEIsQ0FBQztJQUVqQyxTQUFTLFVBQVUsQ0FBQyxhQUFxQixFQUFFLFNBQWM7UUFDeEQsSUFBSSxLQUFLLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxFQUFFO1lBQzdCLFNBQVMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7U0FDckI7YUFBTSxJQUFJLFNBQVMsRUFBRTtZQUNyQixTQUFTLENBQUMsYUFBYyxDQUFDLEdBQUcsSUFBSSxDQUFDO1NBQ2pDO0lBQ0YsQ0FBQztJQUlELElBQU0sWUFBWSxHQUFrQjtRQUNuQztZQUNDLEtBQUssRUFBRSxNQUFNO1lBQ2IsS0FBSztnQkFDSixTQUFTLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO2dCQUNyQixhQUFhLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO2dCQUM3QixJQUFJLEdBQUcsRUFBRSxDQUFDO2dCQUNWLFFBQVEsR0FBRyxTQUFTLENBQUM7WUFDdEIsQ0FBQztTQUNEO1FBQ0Q7WUFDQyxLQUFLLEVBQUUsTUFBTTtZQUNiLEtBQUs7Z0JBQ0osSUFBTSxTQUFTLEdBQUcsU0FBUyxDQUFDLEdBQUcsRUFBRSxDQUFDO2dCQUNsQyxJQUFNLGFBQWEsR0FBRyxhQUFhLENBQUMsR0FBRyxFQUFFLENBQUM7Z0JBRTFDLElBQUksU0FBUyxFQUFFO29CQUNkLFVBQVUsQ0FBQyxhQUFjLEVBQUUsU0FBUyxDQUFDLENBQUM7b0JBQ3RDLElBQUksR0FBRyxTQUFTLENBQUM7aUJBQ2pCO1lBQ0YsQ0FBQztTQUNEO1FBQ0Q7WUFDQyxLQUFLLEVBQUUsWUFBWTtZQUNuQixLQUFLLFlBQUMsS0FBSztnQkFDVixJQUFNLE9BQU8sR0FBRyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxFQUFFLENBQUM7Z0JBQ2hDLE9BQU8sT0FBTyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDLEdBQUcsQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDO1lBQzVELENBQUM7U0FDRDtRQUNEO1lBQ0MsS0FBSyxFQUFFLGNBQWM7WUFDckIsS0FBSyxZQUFDLEtBQUs7Z0JBQ1YsU0FBUyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztnQkFDckIsYUFBYSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDN0IsSUFBSSxHQUFHLEVBQUUsQ0FBQztnQkFDVixRQUFRLEdBQUcsU0FBUyxDQUFDO1lBQ3RCLENBQUM7U0FDRDtRQUNEO1lBQ0MsS0FBSyxFQUFFLE1BQU07WUFDYixLQUFLO2dCQUNKLElBQU0sU0FBUyxHQUFHLFNBQVMsQ0FBQyxHQUFHLEVBQUUsQ0FBQztnQkFDbEMsSUFBTSxhQUFhLEdBQUcsYUFBYSxDQUFDLEdBQUcsRUFBRSxDQUFDO2dCQUMxQyxVQUFVLENBQUMsYUFBYyxFQUFFLFNBQVMsQ0FBQyxDQUFDO2dCQUN0QyxJQUFJLEdBQUcsU0FBUyxDQUFDO1lBQ2xCLENBQUM7U0FDRDtRQUNEO1lBQ0MsS0FBSyxFQUFFLGtCQUFrQjtZQUN6QixLQUFLLFlBQUMsS0FBSztnQkFDVixRQUFRLEdBQUcsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ3JCLENBQUM7U0FDRDtRQUNEO1lBQ0MsS0FBSyxFQUFFLHlCQUF5QjtZQUNoQyxLQUFLLFlBQUMsS0FBSztnQkFDVixRQUFRLEdBQUcsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUNwQixJQUFNLElBQUksR0FBRyxXQUFXLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBRW5DLElBQUksS0FBSyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsRUFBRTtvQkFDeEIsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztpQkFDaEI7cUJBQU0sSUFBSSxJQUFJLEVBQUU7b0JBQ2hCLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxJQUFJLENBQUM7aUJBQ3RCO2dCQUVELE9BQU8sSUFBSSxDQUFDO1lBQ2IsQ0FBQztTQUNEO1FBQ0Q7WUFDQyxLQUFLLEVBQUUsZUFBZTtZQUN0QixLQUFLLFlBQUMsS0FBSztnQkFDVixPQUFPLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLFdBQVc7WUFDN0IsQ0FBQztTQUNEO1FBQ0Q7WUFDQyxLQUFLLEVBQUUsZ0JBQWdCO1lBQ3ZCLEtBQUssWUFBQyxLQUFLO2dCQUNWLE9BQU8sVUFBVSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQzdCLENBQUM7U0FDRDtRQUNEO1lBQ0MsS0FBSyxFQUFFLFdBQVc7WUFDbEIsS0FBSyxZQUFDLEtBQUs7Z0JBQ1YsT0FBTyxRQUFRLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1lBQy9CLENBQUM7U0FDRDtRQUNEO1lBQ0MsS0FBSyxFQUFFLGdCQUFnQjtZQUN2QixLQUFLLFlBQUMsS0FBSztnQkFDVixPQUFPLEtBQUssQ0FBQyxDQUFDLENBQUMsS0FBSyxNQUFNLENBQUM7WUFDNUIsQ0FBQztTQUNEO1FBQ0Q7WUFDQyxLQUFLLEVBQUUsSUFBSTtZQUNYLEtBQUs7WUFDTCxDQUFDO1NBQ0Q7S0FDRCxDQUFDO0lBRUYsS0FBbUIsVUFBSyxFQUFMLGVBQUssRUFBTCxtQkFBSyxFQUFMLElBQUssRUFBRTtRQUFyQixJQUFNLElBQUksY0FBQTtRQUNkLElBQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDO1FBQy9DLFdBQVcsQ0FBQyxPQUFPLENBQUMsQ0FBQztLQUNyQjtJQUVELFNBQVMsV0FBVyxDQUFDLElBQVk7UUFDaEMsS0FBK0IsVUFBWSxFQUFaLDZCQUFZLEVBQVosMEJBQVksRUFBWixJQUFZLEVBQUU7WUFBbEMsSUFBQSx1QkFBZ0IsRUFBZCxnQkFBSyxFQUFFLGdCQUFLO1lBQ3hCLElBQU0sS0FBSyxHQUFHLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7WUFFL0IsSUFBSSxLQUFLLEVBQUU7Z0JBQ1YsT0FBTyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUM7YUFDcEI7U0FDRDtRQUVELE1BQU0sSUFBSSxLQUFLLENBQUMsZ0NBQThCLElBQU0sQ0FBQyxDQUFDO0lBQ3ZELENBQUM7SUFFRCxvRUFBb0U7SUFDcEUseUZBQXlGO0lBRXpGLE9BQU8sSUFBSSxDQUFDO0FBQ2IsQ0FBQztBQUVELE1BQU0sVUFBVSxtQkFBbUIsQ0FBQyxJQUFTO0lBQzVDLElBQUksTUFBTSxHQUFHLEVBQUUsQ0FBQztJQUNoQixJQUFJLEtBQUssR0FBYSxDQUFDLEVBQUUsRUFBRSxFQUFFLENBQUMsQ0FBQztJQUUvQixTQUFTLGlCQUFpQixDQUFDLEdBQVcsRUFBRSxLQUFVO1FBQ2pELElBQU0sS0FBSyxHQUFHLEtBQUssQ0FBQyxNQUFNLENBQUM7UUFDM0IsS0FBSyxDQUFDLElBQUksQ0FBSSxNQUFNLFNBQUksR0FBSyxDQUFDLENBQUM7UUFDL0IsSUFBTSxVQUFVLEdBQUcsY0FBYyxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBRXpDLElBQUksVUFBVSxFQUFFO1lBQ2YsS0FBSyxDQUFDLEtBQUssQ0FBQyxJQUFJLEdBQUcsR0FBRyxVQUFVLENBQUM7U0FDakM7SUFDRixDQUFDO0lBRUQsU0FBUyxlQUFlLENBQUMsS0FBYTtRQUNyQyxJQUFJLENBQUMsS0FBSyxHQUFHLENBQUMsQ0FBQyxLQUFLLEtBQUssRUFBRTtZQUMxQixPQUFPLEtBQUssQ0FBQyxRQUFRLEVBQUUsQ0FBQztTQUN4QjthQUFNO1lBQ04sT0FBTyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxVQUFVLEVBQUUsSUFBSSxDQUFDLENBQUM7U0FDbEQ7SUFDRixDQUFDO0lBRUQsU0FBUyxjQUFjLENBQUMsS0FBVTtRQUNqQyxJQUFJLE9BQU8sS0FBSyxLQUFLLFFBQVEsRUFBRTtZQUM5QixPQUFPLGVBQWUsQ0FBQyxLQUFLLENBQUMsQ0FBQztTQUM5QjthQUFNLElBQUksT0FBTyxLQUFLLEtBQUssU0FBUyxFQUFFO1lBQ3RDLE9BQU8sS0FBSyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQztTQUNoQzthQUFNLElBQUksT0FBTyxLQUFLLEtBQUssUUFBUSxFQUFFO1lBQ3JDLElBQUksT0FBTyxHQUFHLGNBQWMsQ0FBQztZQUU3QixLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsS0FBSyxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRTtnQkFDdEMsSUFBTSxRQUFRLEdBQUcsS0FBSyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDckMsT0FBTyxJQUFJLEtBQUcsTUFBTSxDQUFDLFlBQVksQ0FBQyxRQUFRLElBQUksQ0FBQyxDQUFDLEdBQUcsTUFBTSxDQUFDLFlBQVksQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFHLENBQUM7YUFDMUY7WUFFRCxPQUFPLE1BQUksT0FBTyxNQUFHLENBQUM7U0FDdEI7YUFBTSxJQUFJLEtBQUssQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLEVBQUU7WUFDaEMsSUFBSSxLQUFLLENBQUMsS0FBSyxDQUFDLFVBQUEsQ0FBQyxJQUFJLE9BQUEsT0FBTyxDQUFDLEtBQUssUUFBUSxFQUFyQixDQUFxQixDQUFDLEVBQUU7Z0JBQzVDLE9BQU8sT0FBSyxLQUFLLENBQUMsR0FBRyxDQUFDLGVBQWUsQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsT0FBSSxDQUFDO2FBQ3JEO2lCQUFNO2dCQUNOLElBQU0sSUFBSSxHQUFHLE1BQU0sQ0FBQztnQkFDcEIsTUFBTSxHQUFHLE1BQU0sR0FBRyxJQUFJLENBQUM7Z0JBRXZCLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxLQUFLLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRSxFQUFFO29CQUN0QyxJQUFNLFVBQVUsR0FBRyxjQUFjLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7b0JBRTVDLElBQUksVUFBVSxFQUFFO3dCQUNmLEtBQUssQ0FBQyxJQUFJLENBQUMsS0FBRyxNQUFNLEdBQUcsVUFBWSxDQUFDLENBQUM7cUJBQ3JDO2lCQUNEO2dCQUVELE1BQU0sR0FBRyxJQUFJLENBQUM7Z0JBQ2QsS0FBSyxDQUFDLElBQUksQ0FBSSxNQUFNLE1BQUcsQ0FBQyxDQUFDO2dCQUN6QixPQUFPLEdBQUcsQ0FBQzthQUNYO1NBQ0Q7YUFBTSxJQUFJLE9BQU8sS0FBSyxLQUFLLFFBQVEsRUFBRTtZQUNyQyxLQUFLLENBQUMsSUFBSSxDQUFJLE1BQU0sT0FBSSxDQUFDLENBQUM7WUFDMUIsSUFBTSxJQUFJLEdBQUcsTUFBTSxDQUFDO1lBQ3BCLE1BQU0sR0FBRyxNQUFNLEdBQUcsSUFBSSxDQUFDO1lBRXZCLEtBQWtCLFVBQWtCLEVBQWxCLEtBQUEsTUFBTSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsRUFBbEIsY0FBa0IsRUFBbEIsSUFBa0IsRUFBRTtnQkFBakMsSUFBTSxHQUFHLFNBQUE7Z0JBQ2IsaUJBQWlCLENBQUMsR0FBRyxFQUFFLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO2FBQ25DO1lBRUQsTUFBTSxHQUFHLElBQUksQ0FBQztZQUNkLEtBQUssQ0FBQyxJQUFJLENBQUksTUFBTSxPQUFJLENBQUMsQ0FBQztTQUMxQjtRQUVELE9BQU8sU0FBUyxDQUFDO0lBQ2xCLENBQUM7SUFFRCxjQUFjLENBQUMsSUFBSSxDQUFDLENBQUM7SUFFckIsSUFBTSxNQUFNLEdBQUcsSUFBSSxVQUFVLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxVQUFDLEdBQUcsRUFBRSxJQUFJLElBQUssT0FBQSxHQUFHLEdBQUcsSUFBSSxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQXJCLENBQXFCLEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7SUFDekYsSUFBSSxNQUFNLEdBQUcsQ0FBQyxDQUFDO0lBRWYsS0FBbUIsVUFBSyxFQUFMLGVBQUssRUFBTCxtQkFBSyxFQUFMLElBQUssRUFBRTtRQUFyQixJQUFNLElBQUksY0FBQTtRQUNkLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRSxFQUFHLE1BQU0sRUFBRSxFQUFFO1lBQ2hELE1BQU0sQ0FBQyxNQUFNLENBQUMsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDO1NBQ3BDO1FBRUQsTUFBTSxDQUFDLE1BQU0sQ0FBQyxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDcEMsTUFBTSxFQUFFLENBQUM7S0FDVDtJQUVELGtEQUFrRDtJQUVsRCxPQUFPLE1BQU0sQ0FBQztBQUNmLENBQUMiLCJmaWxlIjoiZW5naW5lRGF0YS5qcyIsInNvdXJjZXNDb250ZW50IjpbImV4cG9ydCBmdW5jdGlvbiBwYXJzZUVuZ2luZURhdGEoZGF0YTogbnVtYmVyW10pIHtcclxuXHRjb25zdCBvcGVuQnJhY2tldCA9ICcoJy5jaGFyQ29kZUF0KDApO1xyXG5cdGNvbnN0IGNsb3NlQnJhY2tldCA9ICcpJy5jaGFyQ29kZUF0KDApO1xyXG5cdGxldCB0ZXh0ID0gJyc7XHJcblxyXG5cdGZvciAobGV0IGkgPSAwOyBpIDwgZGF0YS5sZW5ndGg7IGkrKykge1xyXG5cdFx0aWYgKGkgPCBkYXRhLmxlbmd0aCAtIDMgJiYgZGF0YVtpXSA9PT0gb3BlbkJyYWNrZXQgJiYgZGF0YVtpICsgMV0gPT09IDB4ZmUgJiYgZGF0YVtpICsgMl0gPT09IDB4ZmYpIHtcclxuXHRcdFx0dGV4dCArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKGRhdGFbaV0pO1xyXG5cclxuXHRcdFx0Zm9yIChpICs9IDM7IGkgPCAoZGF0YS5sZW5ndGggLSAxKSAmJiBkYXRhW2ldICE9PSBjbG9zZUJyYWNrZXQ7IGkgKz0gMikge1xyXG5cdFx0XHRcdHRleHQgKz0gU3RyaW5nLmZyb21DaGFyQ29kZSgoZGF0YVtpXSA8PCA4KSB8IGRhdGFbaSArIDFdKTtcclxuXHRcdFx0fVxyXG5cclxuXHRcdFx0aS0tO1xyXG5cdFx0fSBlbHNlIHtcclxuXHRcdFx0dGV4dCArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKGRhdGFbaV0pO1xyXG5cdFx0fVxyXG5cdH1cclxuXHJcblx0Y29uc3QgbGluZXMgPSB0ZXh0LnNwbGl0KC9cXG4vZyk7XHJcblx0Y29uc3Qgbm9kZVN0YWNrOiBhbnlbXSA9IFtdO1xyXG5cdGNvbnN0IHByb3BlcnR5U3RhY2s6IChzdHJpbmcgfCB1bmRlZmluZWQpW10gPSBbXTtcclxuXHJcblx0bGV0IG5vZGU6IGFueSA9IHVuZGVmaW5lZDtcclxuXHRsZXQgcHJvcGVydHk6IHN0cmluZyB8IHVuZGVmaW5lZDtcclxuXHJcblx0ZnVuY3Rpb24gdXBkYXRlTm9kZShwcm9wZXJ0eVZhbHVlOiBzdHJpbmcsIG5vZGVWYWx1ZTogYW55KSB7XHJcblx0XHRpZiAoQXJyYXkuaXNBcnJheShub2RlVmFsdWUpKSB7XHJcblx0XHRcdG5vZGVWYWx1ZS5wdXNoKG5vZGUpO1xyXG5cdFx0fSBlbHNlIGlmIChub2RlVmFsdWUpIHtcclxuXHRcdFx0bm9kZVZhbHVlW3Byb3BlcnR5VmFsdWUhXSA9IG5vZGU7XHJcblx0XHR9XHJcblx0fVxyXG5cclxuXHR0eXBlIEluc3RydWN0aW9uID0geyByZWdleDogUmVnRXhwOyBwYXJzZTogKG1hdGNoOiBSZWdFeHBNYXRjaEFycmF5KSA9PiB2b2lkOyB9O1xyXG5cclxuXHRjb25zdCBpbnN0cnVjdGlvbnM6IEluc3RydWN0aW9uW10gPSBbXHJcblx0XHR7IC8vIEhhc2hTdGFydFxyXG5cdFx0XHRyZWdleDogL148PCQvLFxyXG5cdFx0XHRwYXJzZSgpIHtcclxuXHRcdFx0XHRub2RlU3RhY2sucHVzaChub2RlKTtcclxuXHRcdFx0XHRwcm9wZXJ0eVN0YWNrLnB1c2gocHJvcGVydHkpO1xyXG5cdFx0XHRcdG5vZGUgPSB7fTtcclxuXHRcdFx0XHRwcm9wZXJ0eSA9IHVuZGVmaW5lZDtcclxuXHRcdFx0fVxyXG5cdFx0fSxcclxuXHRcdHsgLy8gSGFzaEVuZFxyXG5cdFx0XHRyZWdleDogL14+PiQvLFxyXG5cdFx0XHRwYXJzZSgpIHtcclxuXHRcdFx0XHRjb25zdCBub2RlVmFsdWUgPSBub2RlU3RhY2sucG9wKCk7XHJcblx0XHRcdFx0Y29uc3QgcHJvcGVydHlWYWx1ZSA9IHByb3BlcnR5U3RhY2sucG9wKCk7XHJcblxyXG5cdFx0XHRcdGlmIChub2RlVmFsdWUpIHtcclxuXHRcdFx0XHRcdHVwZGF0ZU5vZGUocHJvcGVydHlWYWx1ZSEsIG5vZGVWYWx1ZSk7XHJcblx0XHRcdFx0XHRub2RlID0gbm9kZVZhbHVlO1xyXG5cdFx0XHRcdH1cclxuXHRcdFx0fSxcclxuXHRcdH0sXHJcblx0XHR7IC8vIFNpbmdsZUxpbmVBcnJheVxyXG5cdFx0XHRyZWdleDogL15cXFsoLiopXFxdJC8sXHJcblx0XHRcdHBhcnNlKG1hdGNoKSB7XHJcblx0XHRcdFx0Y29uc3QgdHJpbW1lZCA9IG1hdGNoWzFdLnRyaW0oKTtcclxuXHRcdFx0XHRyZXR1cm4gdHJpbW1lZCA/IHRyaW1tZWQuc3BsaXQoLyAvZykubWFwKHBhcnNlVG9rZW5zKSA6IFtdO1xyXG5cdFx0XHR9XHJcblx0XHR9LFxyXG5cdFx0eyAvLyBNdWx0aUxpbmVBcnJheVN0YXJ0LFxyXG5cdFx0XHRyZWdleDogL15cXC8oXFx3KykgXFxbJC8sXHJcblx0XHRcdHBhcnNlKG1hdGNoKSB7XHJcblx0XHRcdFx0bm9kZVN0YWNrLnB1c2gobm9kZSk7XHJcblx0XHRcdFx0cHJvcGVydHlTdGFjay5wdXNoKG1hdGNoWzFdKTtcclxuXHRcdFx0XHRub2RlID0gW107XHJcblx0XHRcdFx0cHJvcGVydHkgPSB1bmRlZmluZWQ7XHJcblx0XHRcdH1cclxuXHRcdH0sXHJcblx0XHR7IC8vIE11bHRpTGluZUFycmF5RW5kLFxyXG5cdFx0XHRyZWdleDogL15cXF0kLyxcclxuXHRcdFx0cGFyc2UoKSB7XHJcblx0XHRcdFx0Y29uc3Qgbm9kZVZhbHVlID0gbm9kZVN0YWNrLnBvcCgpO1xyXG5cdFx0XHRcdGNvbnN0IHByb3BlcnR5VmFsdWUgPSBwcm9wZXJ0eVN0YWNrLnBvcCgpO1xyXG5cdFx0XHRcdHVwZGF0ZU5vZGUocHJvcGVydHlWYWx1ZSEsIG5vZGVWYWx1ZSk7XHJcblx0XHRcdFx0bm9kZSA9IG5vZGVWYWx1ZTtcclxuXHRcdFx0fVxyXG5cdFx0fSxcclxuXHRcdHsgLy8gUHJvcGVydHlcclxuXHRcdFx0cmVnZXg6IC9eXFwvKFtBLVowLTldKykkL2ksXHJcblx0XHRcdHBhcnNlKG1hdGNoKSB7XHJcblx0XHRcdFx0cHJvcGVydHkgPSBtYXRjaFsxXTtcclxuXHRcdFx0fVxyXG5cdFx0fSxcclxuXHRcdHsgLy8gUHJvcGVydHlXaXRoRGF0YSxcclxuXHRcdFx0cmVnZXg6IC9eXFwvKFtBLVowLTldKykgKFteXSopJC9pLFxyXG5cdFx0XHRwYXJzZShtYXRjaCkge1xyXG5cdFx0XHRcdHByb3BlcnR5ID0gbWF0Y2hbMV07XHJcblx0XHRcdFx0Y29uc3QgZGF0YSA9IHBhcnNlVG9rZW5zKG1hdGNoWzJdKTtcclxuXHJcblx0XHRcdFx0aWYgKEFycmF5LmlzQXJyYXkobm9kZSkpIHtcclxuXHRcdFx0XHRcdG5vZGUucHVzaChkYXRhKTtcclxuXHRcdFx0XHR9IGVsc2UgaWYgKG5vZGUpIHtcclxuXHRcdFx0XHRcdG5vZGVbcHJvcGVydHldID0gZGF0YTtcclxuXHRcdFx0XHR9XHJcblxyXG5cdFx0XHRcdHJldHVybiBkYXRhO1xyXG5cdFx0XHR9XHJcblx0XHR9LFxyXG5cdFx0eyAvLyBTdHJpbmdcclxuXHRcdFx0cmVnZXg6IC9eXFwoKFteXSopXFwpJC9tLFxyXG5cdFx0XHRwYXJzZShtYXRjaCkge1xyXG5cdFx0XHRcdHJldHVybiBtYXRjaFsxXTsgLy8gLnRyaW0oKTtcclxuXHRcdFx0fVxyXG5cdFx0fSxcclxuXHRcdHsgLy8gTnVtYmVyV2l0aERlY2ltYWxcclxuXHRcdFx0cmVnZXg6IC9eKC0/XFxkKlxcLlxcZCspJC8sXHJcblx0XHRcdHBhcnNlKG1hdGNoKSB7XHJcblx0XHRcdFx0cmV0dXJuIHBhcnNlRmxvYXQobWF0Y2hbMV0pO1xyXG5cdFx0XHR9XHJcblx0XHR9LFxyXG5cdFx0eyAvLyBOdW1iZXJcclxuXHRcdFx0cmVnZXg6IC9eKC0/XFxkKykkLyxcclxuXHRcdFx0cGFyc2UobWF0Y2gpIHtcclxuXHRcdFx0XHRyZXR1cm4gcGFyc2VJbnQobWF0Y2hbMV0sIDEwKTtcclxuXHRcdFx0fVxyXG5cdFx0fSxcclxuXHRcdHsgLy8gQm9vbGVhblxyXG5cdFx0XHRyZWdleDogL14odHJ1ZXxmYWxzZSkkLyxcclxuXHRcdFx0cGFyc2UobWF0Y2gpIHtcclxuXHRcdFx0XHRyZXR1cm4gbWF0Y2hbMV0gPT09ICd0cnVlJztcclxuXHRcdFx0fVxyXG5cdFx0fSxcclxuXHRcdHsgLy8gTm9vcFxyXG5cdFx0XHRyZWdleDogL14kLyxcclxuXHRcdFx0cGFyc2UoKSB7XHJcblx0XHRcdH1cclxuXHRcdH0sXHJcblx0XTtcclxuXHJcblx0Zm9yIChjb25zdCBsaW5lIG9mIGxpbmVzKSB7XHJcblx0XHRjb25zdCBjbGVhbmVkID0gbGluZS5yZXBsYWNlKC9cXHQvZywgJycpLnRyaW0oKTtcclxuXHRcdHBhcnNlVG9rZW5zKGNsZWFuZWQpO1xyXG5cdH1cclxuXHJcblx0ZnVuY3Rpb24gcGFyc2VUb2tlbnMobGluZTogc3RyaW5nKSB7XHJcblx0XHRmb3IgKGNvbnN0IHsgcmVnZXgsIHBhcnNlIH0gb2YgaW5zdHJ1Y3Rpb25zKSB7XHJcblx0XHRcdGNvbnN0IG1hdGNoID0gcmVnZXguZXhlYyhsaW5lKTtcclxuXHJcblx0XHRcdGlmIChtYXRjaCkge1xyXG5cdFx0XHRcdHJldHVybiBwYXJzZShtYXRjaCk7XHJcblx0XHRcdH1cclxuXHRcdH1cclxuXHJcblx0XHR0aHJvdyBuZXcgRXJyb3IoYFVucGFyc2VkIGVuZ2luZSBkYXRhIGxpbmU6ICR7bGluZX1gKTtcclxuXHR9XHJcblxyXG5cdC8vIGNvbnNvbGUubG9nKEpTT04uc3RyaW5naWZ5KG5vZGUsIG51bGwsIDIpKTsgLy8gLnN1YnN0cigwLCAxMDAwKSk7XHJcblx0Ly8gcmVxdWlyZSgnZnMnKS53cml0ZUZpbGVTeW5jKCdlbmdpbmVEYXRhLmpzb24nLCBKU09OLnN0cmluZ2lmeShub2RlLCBudWxsLCAyKSwgJ3V0ZjgnKTtcclxuXHJcblx0cmV0dXJuIG5vZGU7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBzZXJpYWxpemVFbmdpbmVEYXRhKGRhdGE6IGFueSkge1xyXG5cdGxldCBpbmRlbnQgPSAnJztcclxuXHRsZXQgbGluZXM6IHN0cmluZ1tdID0gWycnLCAnJ107XHJcblxyXG5cdGZ1bmN0aW9uIHNlcmlhbGl6ZVByb3BlcnR5KGtleTogc3RyaW5nLCB2YWx1ZTogYW55KSB7XHJcblx0XHRjb25zdCBpbmRleCA9IGxpbmVzLmxlbmd0aDtcclxuXHRcdGxpbmVzLnB1c2goYCR7aW5kZW50fS8ke2tleX1gKTtcclxuXHRcdGNvbnN0IHNlcmlhbGl6ZWQgPSBzZXJpYWxpemVWYWx1ZSh2YWx1ZSk7XHJcblxyXG5cdFx0aWYgKHNlcmlhbGl6ZWQpIHtcclxuXHRcdFx0bGluZXNbaW5kZXhdICs9ICcgJyArIHNlcmlhbGl6ZWQ7XHJcblx0XHR9XHJcblx0fVxyXG5cclxuXHRmdW5jdGlvbiBzZXJpYWxpemVOdW1iZXIodmFsdWU6IG51bWJlcikge1xyXG5cdFx0aWYgKCh2YWx1ZSB8IDApID09PSB2YWx1ZSkge1xyXG5cdFx0XHRyZXR1cm4gdmFsdWUudG9TdHJpbmcoKTtcclxuXHRcdH0gZWxzZSB7XHJcblx0XHRcdHJldHVybiB2YWx1ZS50b0ZpeGVkKDMpLnJlcGxhY2UoLyhcXGQpMCskL2csICckMScpO1xyXG5cdFx0fVxyXG5cdH1cclxuXHJcblx0ZnVuY3Rpb24gc2VyaWFsaXplVmFsdWUodmFsdWU6IGFueSkge1xyXG5cdFx0aWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ251bWJlcicpIHtcclxuXHRcdFx0cmV0dXJuIHNlcmlhbGl6ZU51bWJlcih2YWx1ZSk7XHJcblx0XHR9IGVsc2UgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ2Jvb2xlYW4nKSB7XHJcblx0XHRcdHJldHVybiB2YWx1ZSA/ICd0cnVlJyA6ICdmYWxzZSc7XHJcblx0XHR9IGVsc2UgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ3N0cmluZycpIHtcclxuXHRcdFx0bGV0IGVuY29kZWQgPSAnXFx1MDBmZVxcdTAwZmYnO1xyXG5cclxuXHRcdFx0Zm9yIChsZXQgaSA9IDA7IGkgPCB2YWx1ZS5sZW5ndGg7IGkrKykge1xyXG5cdFx0XHRcdGNvbnN0IGNoYXJDb2RlID0gdmFsdWUuY2hhckNvZGVBdChpKTtcclxuXHRcdFx0XHRlbmNvZGVkICs9IGAke1N0cmluZy5mcm9tQ2hhckNvZGUoY2hhckNvZGUgPj4gOCl9JHtTdHJpbmcuZnJvbUNoYXJDb2RlKGNoYXJDb2RlICYgMHhmZil9YDtcclxuXHRcdFx0fVxyXG5cclxuXHRcdFx0cmV0dXJuIGAoJHtlbmNvZGVkfSlgO1xyXG5cdFx0fSBlbHNlIGlmIChBcnJheS5pc0FycmF5KHZhbHVlKSkge1xyXG5cdFx0XHRpZiAodmFsdWUuZXZlcnkoeCA9PiB0eXBlb2YgeCA9PT0gJ251bWJlcicpKSB7XHJcblx0XHRcdFx0cmV0dXJuIGBbICR7dmFsdWUubWFwKHNlcmlhbGl6ZU51bWJlcikuam9pbignICcpfSBdYDtcclxuXHRcdFx0fSBlbHNlIHtcclxuXHRcdFx0XHRjb25zdCB0ZW1wID0gaW5kZW50O1xyXG5cdFx0XHRcdGluZGVudCA9IGluZGVudCArICdcXHQnO1xyXG5cclxuXHRcdFx0XHRmb3IgKGxldCBpID0gMDsgaSA8IHZhbHVlLmxlbmd0aDsgaSsrKSB7XHJcblx0XHRcdFx0XHRjb25zdCBzZXJpYWxpemVkID0gc2VyaWFsaXplVmFsdWUodmFsdWVbaV0pO1xyXG5cclxuXHRcdFx0XHRcdGlmIChzZXJpYWxpemVkKSB7XHJcblx0XHRcdFx0XHRcdGxpbmVzLnB1c2goYCR7aW5kZW50fSR7c2VyaWFsaXplZH1gKTtcclxuXHRcdFx0XHRcdH1cclxuXHRcdFx0XHR9XHJcblxyXG5cdFx0XHRcdGluZGVudCA9IHRlbXA7XHJcblx0XHRcdFx0bGluZXMucHVzaChgJHtpbmRlbnR9XWApO1xyXG5cdFx0XHRcdHJldHVybiAnWyc7XHJcblx0XHRcdH1cclxuXHRcdH0gZWxzZSBpZiAodHlwZW9mIHZhbHVlID09PSAnb2JqZWN0Jykge1xyXG5cdFx0XHRsaW5lcy5wdXNoKGAke2luZGVudH08PGApO1xyXG5cdFx0XHRjb25zdCB0ZW1wID0gaW5kZW50O1xyXG5cdFx0XHRpbmRlbnQgPSBpbmRlbnQgKyAnXFx0JztcclxuXHJcblx0XHRcdGZvciAoY29uc3Qga2V5IG9mIE9iamVjdC5rZXlzKHZhbHVlKSkge1xyXG5cdFx0XHRcdHNlcmlhbGl6ZVByb3BlcnR5KGtleSwgdmFsdWVba2V5XSk7XHJcblx0XHRcdH1cclxuXHJcblx0XHRcdGluZGVudCA9IHRlbXA7XHJcblx0XHRcdGxpbmVzLnB1c2goYCR7aW5kZW50fT4+YCk7XHJcblx0XHR9XHJcblxyXG5cdFx0cmV0dXJuIHVuZGVmaW5lZDtcclxuXHR9XHJcblxyXG5cdHNlcmlhbGl6ZVZhbHVlKGRhdGEpO1xyXG5cclxuXHRjb25zdCBidWZmZXIgPSBuZXcgVWludDhBcnJheShsaW5lcy5yZWR1Y2UoKHN1bSwgbGluZSkgPT4gc3VtICsgbGluZS5sZW5ndGggKyAxLCAwKSAtIDEpO1xyXG5cdGxldCBvZmZzZXQgPSAwO1xyXG5cclxuXHRmb3IgKGNvbnN0IGxpbmUgb2YgbGluZXMpIHtcclxuXHRcdGZvciAobGV0IGkgPSAwOyBpIDwgbGluZS5sZW5ndGg7IGkrKyAsIG9mZnNldCsrKSB7XHJcblx0XHRcdGJ1ZmZlcltvZmZzZXRdID0gbGluZS5jaGFyQ29kZUF0KGkpO1xyXG5cdFx0fVxyXG5cclxuXHRcdGJ1ZmZlcltvZmZzZXRdID0gJ1xcbicuY2hhckNvZGVBdCgwKTtcclxuXHRcdG9mZnNldCsrO1xyXG5cdH1cclxuXHJcblx0Ly8gY29uc29sZS5sb2coJ3NlcmlhbGl6ZWQ6XFxuJywgbGluZXMuam9pbignXFxuJykpO1xyXG5cclxuXHRyZXR1cm4gYnVmZmVyO1xyXG59XHJcbiJdLCJzb3VyY2VSb290IjoiRDpcXFByb2plY3RzXFxnaXRodWJcXGFnLXBzZFxcc3JjIn0=
