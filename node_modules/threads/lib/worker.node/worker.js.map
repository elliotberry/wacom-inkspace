{"version":3,"sources":["worker.node/worker.js"],"names":["lastPort","DEFAULT_PORT","buildExecArgv","process","execArgv","map","matches","arg","match","command","Number","resetPortCounter","Worker","initialRunnable","importScripts","options","slave","fork","join","__dirname","Object","assign","on","handleMessage","bind","handleError","emit","run","toRun","runMethod","runScript","method","send","initByMethod","toString","script","Error","prefixedScriptPath","basepath","node","initByScript","resolve","param","doRun","kill","promise","Promise","reject","resolved","rejected","result","removeListener","err","once","message","error","stack","progress","handleProgress","response","listeners","console"],"mappings":"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","file":"worker.js","sourcesContent":["import child        from 'child_process';\nimport path         from 'path';\nimport EventEmitter from 'eventemitter3';\n\nimport { getConfig } from '../config';\n\n// Mutable variable with the last port used for inspect/inspect-brk.\n// This value is shared among all workers.\nlet lastPort = 0;\n\n// Port used by Node.JS when there is no port specified. See\n// https://nodejs.org/en/docs/inspector/#command-line-options\nconst DEFAULT_PORT = 9229;\nconst buildExecArgv = () => process.execArgv.map(arg => {\n  const matches = arg.match(/^(--inspect(?:-brk)?)(?:=(\\d+))?/);\n  if (!matches) return arg;\n\n  const command = matches[1];\n  if (lastPort === 0) lastPort = Number(matches[2]) || 9229;\n  lastPort++;\n  return `${command}=${lastPort}`\n});\n\n// This function will reset the counter of ports used for inspect/inspect-brk.\n// Used for testing.\nexport const resetPortCounter = () => {\n  lastPort = 0;\n}\n\nexport default class Worker extends EventEmitter {\n  constructor(initialRunnable, importScripts = [], options = {}) {\n    // `importScripts` cannot be consumed, it's just there to keep the API compatible to the browser worker\n    super();\n\n    this.slave = child.fork(path.join(__dirname, 'slave.js'), [], Object.assign(\n      { execArgv: buildExecArgv() },\n      options\n    ));\n    this.slave.on('message', this.handleMessage.bind(this));\n    this.slave.on('error', this.handleError.bind(this));\n    this.slave.on('exit', this.emit.bind(this, 'exit'));\n\n    if (initialRunnable) {\n      this.run(initialRunnable);\n    }\n  }\n\n  run(toRun) {\n    if (typeof toRun === 'function') {\n      this.runMethod(toRun);\n    } else {\n      this.runScript(toRun);\n    }\n    return this;\n  }\n\n  runMethod(method) {\n    this.slave.send({\n      initByMethod : true,\n      method       : method.toString()\n    });\n  }\n\n  runScript(script) {\n    if (!script) { throw new Error('Must pass a function or a script path to run().'); }\n\n    const prefixedScriptPath = path.join(getConfig().basepath.node, script);\n\n    // attention: single script for node, array for browser\n    this.slave.send({\n      initByScript : true,\n      script       : path.resolve(prefixedScriptPath)\n    });\n  }\n\n  send(param) {\n    this.slave.send({\n      doRun : true,\n      param\n    });\n    return this;\n  }\n\n  kill() {\n    this.slave.kill();\n    return this;\n  }\n\n  promise() {\n    return new Promise((resolve, reject) => {\n      let resolved, rejected;\n      resolved = (result) => {\n        this.removeListener('error', rejected);\n        resolve(result);\n      };\n      rejected = (err) => {\n        this.removeListener('message', resolved);\n        reject(err);\n      };\n\n      this\n        .once('message', resolved)\n        .once('error', rejected);\n    });\n  }\n\n  handleMessage(message) {\n    if (message.error) {\n      const error = new Error(message.error.message);\n      error.stack = message.error.stack;\n\n      this.handleError(error);\n    } else if (message.progress) {\n      this.handleProgress(message.progress);\n    } else {\n      this.emit('message', ...message.response);\n      this.emit('done', ...message.response);    // this one is just for convenience\n    }\n  }\n\n  handleProgress(progress) {\n    this.emit('progress', progress);\n  }\n\n  handleError(error) {\n    if (!this.listeners('error', true)) {\n      console.error(error.stack || error);       // eslint-disable-line no-console\n    }\n    this.emit('error', error);\n  }\n}\n"]}